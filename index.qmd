---
title: "Selection (preliminary)"
link-external-newwindow: true
---

```{r setup}
library(tidyverse)
library(kableExtra)
library(lubridate)
library(ganttrify)
library(tinytable)
library(codename)
library(blocksdesign) # randomly assign reviewers
library(reactable)
library(crosstalk)
library(gghalves)
library(plotly)
```

```{r functions}
source("R/functions.R")
```

```{r}
# read reviews
reviews_wide <- read_csv("reviews/reviews_wide.csv") |> 
  select(
    code_name,
    overall_std_score,
    reviewer_comments_1,
    reviewer_comments_2,
    reviewer_comments_3,
    description,
    stimulus,
    tested,
    outcome_previous_tests,
    effective,
    effect_size,
    citation,
    comment
  ) |> 
  # make this order the default
  arrange(desc(overall_std_score)) |> 
  mutate(
    ranking_std = min_rank(desc(overall_std_score))
  ) |> 
  select(-overall_std_score)

# read screening sheet with decisions
reviews_screening <- read_csv("reviews/review_screening_viktoria_jan.csv") |> 
  # change some variables
  mutate(
    decision = case_when(
      decision == "remove" ~ "‚ùå Remove",
      decision == "merge"  ~ paste0("üîÄ Merge with: ", similar_to),
      decision == "adapt"  ~ "‚úèÔ∏è Adapt",
      TRUE                     ~ "‚úÖ Keep"),
    selected = ifelse(
      str_detect(decision, "Remove"), 
      NA_character_,
      "selected")
  ) 

# combine both with reduced variables
reviews_decisions <- reviews_screening |> 
  select(
    - rank_new, 
    - rank_old, 
    - selected,
    - similar_to
  ) |> 
  left_join(reviews_wide) |> 
  select(code_name, ranking_std, decision, everything())

```

We will be able to test 20 interventions in our megastudy. The research team has made preliminary decisions on which intervention proposals to select. We would like to give you the opportunity to challenge these decisions (or support them, if you agree). 

We used the (standardized) aggregate scores from your individual reviews as a baseline: by default, the interventions that made it into the top 20 will be selected for testing. 

However, screening the reviews and the top 20, the research team has set additional inclusion criteria, which not all interventions in the top 20 met. 

::: {.callout-important}
We encourage you to raise concerns regarding our preliminary selection decisions.

Please use this [üìÑ google doc](https://docs.google.com/document/d/1RHu_dxYxn8zbfo1F3EAVPXYJ7eB6gA7ZeejHZwLXkv0/edit?tab=t.0) 

Please also feel free to use the data explorer to see if there are other interventions that you would really like to see included (e.g. for reasons of diversity or novelty). If that is the case please send me an email (janlukas.pfaender@gmail.com).

You have time to provide feedback **until January 5, 2026**.

Thank you!!
:::

## Inclusion criteria

1. No fictional characters

Several interventions use fictional scientists, journals, or scientific communities. It is hard to anticipate if these interventions will become practically relevant. Further, they require that we debrief participants after the intervention, for ethical reasons. This is problematic for the follow-up study: we will likely not have persistent effects from fictional interventions, or worse, we might even find negative long-term effects if participants felt we were just making things up. 

2. Diversity 

Ideally, we want to test a wide range of different interventions. With similar interventions, we used two strategies to avoid redundancy: When there were complementary elements, we suggested merging (and we will offer co-authorship to all involved teams). When two interventions were essentially the same, we picked the one that was better ranked. 
  
3. Major concerns on effectiveness

We suggest excluding one intervention, because we believe it is too unrelated to our outcome variable, trust in climate scientists. In another case, we justified exclusions with major concerns stated in one of the reviewer comments (but in this case, in addition, a similar and higher-ranked intervention was already included). 

## Selection

@tbl-summary provides a summary, and @tbl-detail lists all decisions as proposed by the research team. These decisions are not final. 

```{r}
#| label: tbl-summary
#| tbl-cap: "Summary table" 

reviews_decisions |> 
  mutate(decision = if_else(
    str_detect(decision, "Merge"),
    "üîÄ Merge",
    decision
  )) |> 
  group_by(decision) |> 
  summarise(n = n_distinct(code_name), .groups = "drop") |> 
  kbl(align = "c") |> 
  kableExtra::kable_styling(position = "center")

```


```{r}
#| label: tbl-detail
#| tbl-cap: "Detailed table with all decisions" 
# The reactable table is inspired by this https://github.com/askozyreva/toolbox/blob/main/analysis/table_evidence.Rmd
# https://interventionstoolbox.mpib-berlin.mpg.de/table_evidence.html
#| tbl-align: left

# the package and examples can be found here: https://glin.github.io/reactable/index.html


htmltools::tags$style("
  .details-box, .detail-text {
    white-space: pre-wrap;
    word-wrap: break-word; 
    overflow-wrap: break-word;
  }
")

data <- SharedData$new(
  reviews_decisions 
)



# get all details into row details
row_details <- function(index) {
  df <- data$data()        # extract underlying data frame
  row <- df[index, , drop = FALSE]

field <- function(label, value) {
  if (is.null(value) || is.na(value) || value == "") return(NULL)

  htmltools::tagList(
    # Header
    htmltools::div(
      style = "
        font-weight: 600;
        margin-top: 10px;
        color: #333;
        font-size: 0.95rem;
      ",
      label
    ),

    # Body text
    htmltools::pre(
      style = "
        margin-left: 12px;
        margin-top: 2px;
        margin-bottom: 10px;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        font-size: 0.9rem;
      ",
      value
    )
  )
}

  htmltools::div(
    class = "details-box",
    field("Decision notes", row$screening_notes),
    field("Intervention content", row$content),
    field("Reviewer comments ‚Äî reviewer 1", row$reviewer_comments_1),
    field("Reviewer comments ‚Äî reviewer 2", row$reviewer_comments_2),
    field("Reviewer comments ‚Äî reviewer 3", row$reviewer_comments_3),
    field("Description", row$description),
    field("Stimulus", row$stimulus),
    field("Tested before?", row$tested), 
    field("Outcome previous test", row$outcome_previous_tests), 
    field("Effective?", row$effective), 
    field("Effect size", row$effect_size),
    field("Citation", row$citation),
    field("Comment", row$comment)
  )
}


reactable_data <- reactable(
  data,
  details = row_details,
  pagination = FALSE,
  columns = list(
    code_name = colDef(
      sticky = "left",
      style = list(borderRight = "1px solid #eee"),
      headerStyle = list(borderRight = "1px solid #eee")
    ),
    screening_notes = colDef(show = FALSE),
    content = colDef(show = FALSE),
    description = colDef(show = FALSE),
    stimulus = colDef(show = FALSE),
    reviewer_comments_1 = colDef(show = FALSE),
    reviewer_comments_2 = colDef(show = FALSE),
    reviewer_comments_3 = colDef(show = FALSE),
    tested = colDef(show = FALSE),
    outcome_previous_tests = colDef(show = FALSE),
    effective = colDef(show = FALSE),
    effect_size = colDef(show = FALSE),
    citation = colDef(show = FALSE), 
    comment = colDef(show = FALSE)
  ),
  searchable = TRUE,
  elementId = "reviews-table"
)

# produce table
htmltools::div(
  style = "text-align: left;",
  reactable_data
)
```

```{r}
# generate a table to copy paste in word document

# reviews_decisions |> 
#   mutate(concerns = NA_character_) |> 
#   select(code_name, decision, concerns) |> 
#   kbl()
```

## Content diversity

A note on content diversity: As shown in @tbl-content, the current selection covers most of the (very rough) content labels we had originally assigned.

```{r}
#| label: tbl-content
#| tbl-cap: "Overview of how the different content labels are represented in the selection" 
#| 
# content diversity
content_diversity <- read_csv("reviews/reviews_wide.csv") |> 
  left_join(reviews_screening) |> 
  select(code_name, intervention_content, selected) |> 
  mutate(selected = ifelse(is.na(selected), 
                "not_selected", 
                selected)
         )
  
content_summary <- content_diversity |> 
  group_by(intervention_content, selected) |> 
  summarise(n = n_distinct(code_name)) |> 
  pivot_wider(names_from = selected, 
              values_from = n,
              values_fill = 0) 

content_summary |> 
  kbl() |> 
  kableExtra::row_spec(
    which(content_summary$selected == 0),
    bold = TRUE,
    background = "#fff3cd"
  )
```














