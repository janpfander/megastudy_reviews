---
title: "Standardized ratings"
---

```{r setup}
library(tidyverse)
library(kableExtra)
library(lubridate)
library(ganttrify)
library(tinytable)
library(codename)
library(blocksdesign) # randomly assign reviewers
library(reactable)
library(crosstalk)
library(gghalves)
library(plotly)
```

```{r functions}
source("R/functions.R")
```

```{r}
# read reviews
reviews_wide <- read_csv("reviews/reviews_wide.csv") |> 
  select(
    -overall_score,
    -score_1,
    -score_2,
    -score_3,
    -theoretical_grounding_mean,
    -theoretical_insight_mean,
    -odds_of_success_mean,
    -practical_relevance_mean
  ) |> 
  # make this order the default
  arrange(desc(overall_std_score)) |> 
  mutate(
    ranking_std = min_rank(desc(overall_std_score))
  ) |> 
  select(code_name, ranking_std, overall_std_score, everything(), flag, intervention_format)
```

```{r}
# The reactable table is inspired by this https://github.com/askozyreva/toolbox/blob/main/analysis/table_evidence.Rmd
# https://interventionstoolbox.mpib-berlin.mpg.de/table_evidence.html

# the package and examples can be found here: https://glin.github.io/reactable/index.html


htmltools::tags$style("
  .details-box, .detail-text {
    white-space: pre-wrap;
    word-wrap: break-word; 
    overflow-wrap: break-word;
  }
")

data <- SharedData$new(
  reviews_wide |>
    select(-intervention_id)
)



# get all details into row details
row_details <- function(index) {
  df <- data$data()        # extract underlying data frame
  row <- df[index, , drop = FALSE]

field <- function(label, value) {
  if (is.null(value) || is.na(value) || value == "") return(NULL)

  htmltools::tagList(
    # Header
    htmltools::div(
      style = "
        font-weight: 600;
        margin-top: 10px;
        color: #333;
        font-size: 0.95rem;
      ",
      label
    ),

    # Body text
    htmltools::pre(
      style = "
        margin-left: 12px;
        margin-top: 2px;
        margin-bottom: 10px;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        font-size: 0.9rem;
      ",
      value
    )
  )
}

  htmltools::div(
    class = "details-box",
    field("Reviewer comments — reviewer 1", row$reviewer_comments_1),
    field("Reviewer comments — reviewer 2", row$reviewer_comments_2),
    field("Reviewer comments — reviewer 3", row$reviewer_comments_3),
    field("Description", row$description),
    field("Stimulus", row$stimulus),
    field("Tested before?", row$tested), 
    field("Outcome previous test", row$outcome_previous_tests), 
    field("Effective?", row$effective), 
    field("Effect size", row$effect_size),
    field("Citation", row$citation),
    field("Comment", row$comment)
  )
}


reactable_data <- reactable(
  data,
  details = row_details,
  minRows = 10,
  columns = list(
    code_name = colDef(
      sticky = "left",
      style = list(borderRight = "1px solid #eee"),
      headerStyle = list(borderRight = "1px solid #eee")
    ),
    description = colDef(show = FALSE),
    stimulus = colDef(show = FALSE),
    reviewer_comments_1 = colDef(show = FALSE),
    reviewer_comments_2 = colDef(show = FALSE),
    reviewer_comments_3 = colDef(show = FALSE),
    tested = colDef(show = FALSE),
    outcome_previous_tests = colDef(show = FALSE),
    effective = colDef(show = FALSE),
    effect_size = colDef(show = FALSE),
    citation = colDef(show = FALSE), 
    comment = colDef(show = FALSE)
  ),
  searchable = TRUE,
  elementId = "reviews-table"
)

# produce table
shiny::fluidRow(
  shiny::column(
    4,
    filter_checkbox("intervention_content", "Content", data, ~intervention_content),
    filter_slider("overall_std_score", "Overall score", data, ~overall_std_score, width = "100%", round = 1),
    filter_checkbox("flag", "Flagged", data, ~flag)
  ),
  shiny::column(
    8,
    reactable_data
  )
)
```

















